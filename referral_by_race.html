<!doctype html>
<html>

<head>
  <meta charset="utf8"/>
</head>

<body>
  <!-- based on https://bl.ocks.org/mbostock/3883245 -->
  <svg width='960' height='500'></svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <script>

    var svg = d3.select('svg'),
        margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = +svg.attr('width') - margin.left - margin.right,
        height = +svg.attr('height') - margin.top - margin.bottom,
        g = svg.append('g').attr('transform',
                                 'translate(' + margin.left + ',' + 
                                                margin.top + ')');

    var parseTime = d3.timeParse('%Y');

    var x = d3.scaleLinear()
              .rangeRound([0, width])
    var y = d3.scaleLinear()
              .rangeRound([height, 0])
    var line = d3.line()
                 .x(function(d) { return x(d.year); })
                 .y(function(d) { return y(d.referralPercentage); })

    d3.csv(
      'nonpublicdata/simulated_JCPSS.csv',
      function(error, data) {
        if (error) {throw error;}

        // help from http://learnjsdata.com/iterate_data.html
        // There is probably a more elegant way to do this with d3
        //  or more likely we should have a bunch of this preprocessed
        //  rather than generating each time
        var counts = {};
        data.forEach(function(d) {
          var year = +d.year;
          if (!counts.hasOwnProperty(year)) {
            counts[year] = {'total': 0, 'referrals': 0};
          }
          counts[year].total += 1;
          counts[year].referrals += (d.action_type === 'Referral' ? 1 : 0);
        });

        var percentages = [];
        Object.keys(counts).sort().forEach(function(year) {
          var percentage = counts[year].referrals / counts[year].total;
          percentages.push(
            {
              year: year,
              referralPercentage: percentage,
            }
          );
        });

        x.domain(d3.extent(percentages, function(d) {return d.year; }));
        y.domain(d3.extent(percentages, function(d) {return d.referralPercentage;}));
        g.append('g')
           .attr('transform', 'translate(0,' + height + ')')
           .call(d3.axisBottom(x))
         .select('.domain')
           .remove();

        g.append('g')
           .call(d3.axisLeft(y))
         .append('text')
           .attr('fill', '#000')
           .attr('transform', 'rotate(-90)')
           .attr('y', 6)
           .attr('dy', '0.71em')
           .attr('text-anchor', 'end')
           .text('referral percentages');

        g.append('path')
         .datum(percentages)
         .attr('fill', 'none')
         .attr('stroke', 'steelblue')
         .attr('stroke-linejoin', 'round')
         .attr('stroke-linecap', 'round')
         .attr('stroke-width', 1.5)
         .attr('d', line);
      }
    );
  </script>
</body>

</html>
